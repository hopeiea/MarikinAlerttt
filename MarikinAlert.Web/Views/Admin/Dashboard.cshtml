@using MarikinAlert.Web.Models
@model IEnumerable<DisasterReport>

@{
    ViewData["Title"] = "Command Center";
    Layout = "~/Views/Shared/_AdminLayout.cshtml"; // Applies the Admin UI

    // Stats Logic
    var criticalCount = Model.Count(r => r.Priority == ReportPriority.Critical);
}

<div class="space-y-6 mt-2">
    <div class="flex justify-between items-end">
        <div>
            <h2 class="text-xl font-bold text-white">Live Incidents</h2>
            <p class="text-xs text-slate-400">Marikina Central Cluster • Admin View</p>
        </div>

        @if (criticalCount > 0)
        {
            <div class="bg-red-500/10 border border-red-500/20 px-3 py-1 rounded-full flex items-center gap-2">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-[10px] font-black text-red-500 uppercase">@criticalCount Critical</span>
            </div>
        }
    </div>

    <div class="space-y-4">

@if (!Model.Any())
{
            <div class="p-8 text-center border-2 border-dashed border-slate-700 rounded-xl">
                <p class="text-slate-500 text-sm">System All Clear. No active incidents.</p>
            </div>
}

@foreach (var report in Model.OrderByDescending(x => x.Timestamp))
{
            <div class="block bg-[#0f172a] border-l-4 @(report.Priority == ReportPriority.Critical ? "border-red-500" : "border-emerald-500") p-5 rounded-xl transition-all hover:bg-slate-900">

                <div class="flex flex-wrap justify-between items-start mb-2 gap-2">

                    <div class="flex items-center gap-2">
                        <span class="@(report.Priority == ReportPriority.Critical ? "bg-red-500 text-white" : "bg-emerald-500/20 text-emerald-500") text-[10px] font-black px-2 py-1 rounded uppercase">
                            @report.Priority
                        </span>

                        <form asp-action="UpdateStatus" method="post" class="flex items-center gap-2">
                            <input type="hidden" name="id" value="@report.Id" />
                            <select name="status" onchange="this.form.submit()" class="bg-slate-800 text-[10px] text-white font-bold border border-slate-600 rounded px-2 py-1 outline-none focus:border-emerald-500 cursor-pointer uppercase">
                                <option value="Active" selected="@(report.Status == ReportStatus.Active)">Active</option>
                                <option value="OnGoing" selected="@(report.Status == ReportStatus.OnGoing)">On Going</option>
                                <option value="Resolved" selected="@(report.Status == ReportStatus.Resolved)">Resolved</option>
                            </select>
                        </form>

                        <form asp-action="UpdateCategory" method="post" class="flex items-center gap-2 border-l border-white/10 pl-2">
                            <input type="hidden" name="id" value="@report.Id" />
                            <select name="category" onchange="this.form.submit()" class="bg-slate-800 text-[10px] text-slate-300 font-bold border border-slate-600 rounded px-2 py-1 outline-none focus:border-blue-500 cursor-pointer uppercase tracking-wider">
                                <option value="Fire" selected="@(report.Category == ReportCategory.Fire)">Fire</option>
                                <option value="BuildingCollapse" selected="@(report.Category == ReportCategory.BuildingCollapse)">Collapse</option>
                                <option value="Medical" selected="@(report.Category == ReportCategory.Medical)">Medical</option>
                                <option value="Logistics" selected="@(report.Category == ReportCategory.Logistics)">Logistics</option>
                                <option value="Infrastructure" selected="@(report.Category == ReportCategory.Infrastructure)">Infra</option>
                                <option value="Noise" selected="@(report.Category == ReportCategory.Noise)">Noise</option>
                            </select>

                            @if (report.Category == ReportCategory.Fire)
                            {
                                <i class="ph-fill ph-fire text-orange-500"></i>
                            }
                            else if (report.Category == ReportCategory.Medical)
                            {

                                <i class="ph-fill ph-first-aid text-red-500"></i>
                            }
                            else if (report.Category == ReportCategory.BuildingCollapse)
                            {

                                <i class="ph-fill ph-house-line text-yellow-500"></i>
                            }
                            else
                            {

                                <i class="ph-fill ph-info text-blue-500"></i>
                            }
                        </form>
                    </div>

                    <span class="text-[10px] text-slate-500 font-mono pt-1">
                        @report.Timestamp.ToString("HH:mm")
                    </span>
                </div>

                <h3 class="font-bold text-lg text-white leading-tight mb-1">@report.Location</h3>
                <p class="text-sm text-slate-400 mb-3 line-clamp-2">"@report.RawMessage"</p>

                <div class="flex items-center gap-4 text-xs font-bold text-slate-500 border-t border-white/5 pt-3 mt-3">
                    <span class="flex items-center gap-1">
                        <i class="ph-fill ph-user"></i> @report.SenderName
                    </span>
                    <span class="flex items-center gap-1">
                        <i class="ph-fill ph-phone"></i> @report.ContactNumber
                    </span>
                </div>
            </div>
}
